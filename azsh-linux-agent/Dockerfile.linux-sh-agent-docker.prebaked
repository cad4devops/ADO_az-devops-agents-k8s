FROM ubuntu:24.04

# Agent version as build argument (fetched dynamically by build script)
ARG AGENT_VERSION=4.261.0
ARG AGENT_USER=azpagent # retained for backward compatibility (not created when running as root)
ARG AGENT_UID=1000
ARG AGENT_GID=1000

# Docker install
RUN apt-get update && apt-get install --no-install-recommends -y \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg-agent \
    software-properties-common
RUN curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
RUN apt-key fingerprint 0EBFCD88

RUN add-apt-repository \
    "deb [arch=amd64] https://download.docker.com/linux/ubuntu \
    $(lsb_release -cs) \
    stable"
RUN apt-get update && apt-get install --no-install-recommends -y docker-ce docker-ce-cli containerd.io

RUN apt update -y && apt upgrade -y && apt install curl git jq libicu74 -y

# Also can be "linux-arm", "linux-arm64".
ENV TARGETARCH="linux-x64"

COPY ./install-linux-agent-tools.sh /tmp/install-linux-agent-tools.sh
RUN bash /tmp/install-linux-agent-tools.sh
RUN rm /tmp/install-linux-agent-tools.sh

### Running as root (DinD scenario) ###
RUN set -eux; mkdir -p /azp; echo "Running as root; skipping dedicated agent user creation (AGENT_ALLOW_RUNASROOT enabled)."

WORKDIR /azp/

# Pre-download the Azure Pipelines agent during build
# This eliminates runtime download and improves pod startup time
RUN echo "Downloading Azure Pipelines agent v${AGENT_VERSION} as root..." && \
    DOWNLOAD_URL="https://download.agent.dev.azure.com/agent/${AGENT_VERSION}/vsts-agent-linux-x64-${AGENT_VERSION}.tar.gz" && \
    echo "Download URL: ${DOWNLOAD_URL}" && \
    mkdir -p /azp/agent && \
    curl -LsS "${DOWNLOAD_URL}" | tar -xz -C /azp/agent && \
    chown -R root:root /azp && \
    echo "Agent v${AGENT_VERSION} ready."

COPY ./start-prebaked.sh ./start.sh
RUN chmod +x ./start.sh

ENV AGENT_ALLOW_RUNASROOT="true"

# Intentionally remain as root for DinD support

# Set start.sh script as ENTRYPOINT.
ENTRYPOINT ["/azp/start.sh"]
